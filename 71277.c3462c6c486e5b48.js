"use strict";(self.webpackChunkabp_zero_template=self.webpackChunkabp_zero_template||[]).push([[71277],{71277:(_,y,a)=>{a.r(y),a.d(y,{UpgradeModule:()=>I});var l=a(92337),g=a(91860),p=a(70916),v=a(47530),b=a(41840),s=a(44328),d=a(15047),t=a(99468),f=a(70183),P=a(78812),m=a(96814),u=a(56223),T=a(3291);function S(n,c){1&n&&(t.TgZ(0,"div")(1,"div",10)(2,"label",11),t._uU(3),t.ALo(4,"localize"),t.qZA()()()),2&n&&(t.xp6(3),t.hij(" ",t.lcZ(4,1,"RecurringSubscriptionUpgradeNote")," "))}function A(n,c){if(1&n&&(t.TgZ(0,"div")(1,"div",10)(2,"label",12),t._uU(3),t.ALo(4,"localize"),t.qZA(),t.TgZ(5,"div",13)(6,"p",14),t._uU(7),t.ALo(8,"number"),t.qZA()()()()),2&n){const i=t.oxw(2);t.xp6(3),t.hij(" ",t.lcZ(4,3,"Total")," "),t.xp6(4),t.AsE(" ",i.appSession.application.currencySign,"",t.xi3(8,5,i.additionalPrice,"1.2-2")," ")}}function w(n,c){if(1&n){const i=t.EpF();t.TgZ(0,"button",15),t.NdJ("click",function(){const r=t.CHM(i).$implicit,h=t.oxw(2);return t.KtG(h.checkout(r.gatewayType))}),t._uU(1),t.ALo(2,"localize"),t.qZA()}if(2&n){const i=c.$implicit,e=t.oxw(2);t.xp6(1),t.hij(" ",t.lcZ(2,1,"CheckoutWith"+e.getPaymentGatewayType(i.gatewayType))," ")}}function x(n,c){if(1&n&&(t.TgZ(0,"div",1)(1,"div",2)(2,"h3",3),t._uU(3),t.ALo(4,"localize"),t.qZA()(),t.TgZ(5,"form",4)(6,"h4",5),t._uU(7),t.ALo(8,"localize"),t.qZA(),t._UZ(9,"div",6),t.YNc(10,S,5,3,"div",7),t.YNc(11,A,9,8,"div",7),t.TgZ(12,"div",8),t.YNc(13,w,3,3,"button",9),t.qZA()()()),2&n){const i=t.oxw();t.Q6J("@routerTransition",void 0),t.xp6(3),t.hij(" ",t.lcZ(4,6,"PaymentInfo")," "),t.xp6(4),t.hij(" ",t.xi3(8,8,"Upgrade_Edition_Description",i.edition.displayName)," "),t.xp6(3),t.Q6J("ngIf",i.hasRecurringSubscription()),t.xp6(1),t.Q6J("ngIf",!i.hasRecurringSubscription()),t.xp6(2),t.Q6J("ngForOf",i.paymentGateways)}}const U=[{path:"",component:(()=>{class n extends b.c{constructor(i,e,o,r,h,Z,C){super(i),this._router=e,this._paymentHelperService=o,this._activatedRoute=r,this._paymentAppService=h,this._tenantRegistrationAppService=Z,this._editionHelperService=C,this.subscriptionPaymentType=s.Ykt,this.subscriptionStartType=s.gPM,this.edition=new s._6E,this.tenantId=abp.session.tenantId,this.subscriptionPaymentGateway=s.UWJ,this.editionPaymentTypeCheck=s.qLZ,this.showPaymentForm=!1}ngOnInit(){this.showMainSpinner(),this.editionPaymentType=parseInt(this._activatedRoute.snapshot.queryParams.editionPaymentType),this.upgradeEditionId=this._activatedRoute.snapshot.queryParams.upgradeEditionId,this.appSession.tenant.edition.isFree?this._tenantRegistrationAppService.getEdition(this.upgradeEditionId).subscribe(i=>{this._editionHelperService.isEditionFree(i)?this._paymentAppService.switchBetweenFreeEditions(i.id).subscribe(()=>{this.hideMainSpinner(),this._router.navigate(["app/admin/subscription-management"])}):(this.hideMainSpinner(),this.redirectToBuy())}):this._paymentAppService.hasAnyPayment().subscribe(i=>{if(!i)return this.hideMainSpinner(),void this.redirectToBuy();this._paymentAppService.getPaymentInfo(this.upgradeEditionId).subscribe(e=>{this.edition=e.edition,this.additionalPrice=Number(e.additionalPrice.toFixed(2)),this.additionalPrice<d.g.MinimumUpgradePaymentAmount?this._paymentAppService.upgradeSubscriptionCostsLessThenMinAmount(this.upgradeEditionId).subscribe(()=>{this.spinnerService.hide(),this.showPaymentForm=!0,this._router.navigate(["app/admin/subscription-management"])}):(this.spinnerService.hide(),this.showPaymentForm=!0)}),this._paymentAppService.getLastCompletedPayment().subscribe(e=>{let o=new s.X$y;o.gatewayType=e.gateway,o.supportsRecurringPayments=!0,this.paymentGateways=[o],this.paymentPeriodType=e.paymentPeriodType,this.appSession.tenant.subscriptionPaymentType===this.subscriptionPaymentType.Manual&&this._paymentAppService.getActiveGateways(void 0).subscribe(r=>{this.paymentGateways=r})})})}checkout(i){let e=new s.LQI;e.editionId=this.edition.id,e.editionPaymentType=this.editionPaymentType,e.paymentPeriodType=this.paymentPeriodType,e.recurringPaymentEnabled=this.hasRecurringSubscription(),e.subscriptionPaymentGatewayType=i,e.successUrl=d.g.remoteServiceBaseUrl+"/api/services/app/payment/"+this._paymentHelperService.getEditionPaymentType(this.editionPaymentType)+"Succeed",e.errorUrl=d.g.remoteServiceBaseUrl+"/api/services/app/payment/PaymentFailed",this._paymentAppService.createPayment(e).subscribe(o=>{this._router.navigate(["account/"+this.getPaymentGatewayType(i).toLocaleLowerCase()+"-purchase"],{queryParams:{paymentId:o,isUpgrade:!0,redirectUrl:"app/admin/subscription-management"}})})}getPaymentGatewayType(i){return this._paymentHelperService.getPaymentGatewayType(i)}hasRecurringSubscription(){return this.appSession.tenant.subscriptionPaymentType!==this.subscriptionPaymentType.Manual}redirectToBuy(){this._router.navigate(["account/buy"],{queryParams:{tenantId:this.appSession.tenant.id,editionPaymentType:s.qLZ.BuyNow,editionId:this.upgradeEditionId,subscriptionStartType:this.subscriptionStartType.Paid}})}static#t=this.\u0275fac=function(e){return new(e||n)(t.Y36(t.zs3),t.Y36(p.F0),t.Y36(f.T),t.Y36(p.gz),t.Y36(s.KC),t.Y36(s.Zr1),t.Y36(P.Y))};static#e=this.\u0275cmp=t.Xpm({type:n,selectors:[["ng-component"]],features:[t.qOj],decls:1,vars:1,consts:[["class","login-form",4,"ngIf"],[1,"login-form"],[1,"pb-13","pt-lg-0","pt-5"],[1,"fw-bolder","text-dark","fs-h4","fs-h1-lg"],["method","post",1,"login-form","form"],[1,"mb-2"],[1,"separator","separator-border-dashed"],[4,"ngIf"],[1,"pb-lg-0","pb-5"],["class","btn btn-success w-100",3,"click",4,"ngFor","ngForOf"],[1,"mb-5","row"],[1,"col-sm-12"],[1,"col-sm-8"],[1,"col-sm-4","text-end"],["id","totalPrice",1,"fw-bolder"],[1,"btn","btn-success","w-100",3,"click"]],template:function(e,o){1&e&&t.YNc(0,x,14,11,"div",0),2&e&&t.Q6J("ngIf",o.showPaymentForm)},dependencies:[m.sg,m.O5,u._Y,u.JL,u.F,m.JJ,T.F],encapsulation:2,data:{animation:[(0,v.RP)()]}})}return n})(),pathMatch:"full"}];let E=(()=>{class n{static#t=this.\u0275fac=function(e){return new(e||n)};static#e=this.\u0275mod=t.oAB({type:n});static#i=this.\u0275inj=t.cJS({imports:[p.Bz.forChild(U),p.Bz]})}return n})(),I=(()=>{class n{static#t=this.\u0275fac=function(e){return new(e||n)};static#e=this.\u0275mod=t.oAB({type:n});static#i=this.\u0275inj=t.cJS({imports:[l.o,g.y,E]})}return n})()}}]);